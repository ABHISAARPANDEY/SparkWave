var we=Object.defineProperty;var M=(a,e)=>()=>(a&&(e=a(a=0)),e);var Q=(a,e)=>{for(var n in e)we(a,n,{get:e[n],enumerable:!0})};var O,d,_=M(()=>{"use strict";O=class{users;socialAccounts;campaigns;posts;aiModels;analytics;currentId;constructor(){this.users=new Map,this.socialAccounts=new Map,this.campaigns=new Map,this.posts=new Map,this.aiModels=new Map,this.analytics=new Map,this.currentId=1,this.initializeAiModels()}initializeAiModels(){[{name:"GPT-2",endpoint:"https://huggingface.co/gpt2",isActive:!0,isFree:!0},{name:"GPT-Neo",endpoint:"https://huggingface.co/EleutherAI/gpt-neo-2.7B",isActive:!1,isFree:!0}].forEach(n=>this.createAiModel(n))}async getUser(e){return this.users.get(e)}async getUserByEmail(e){return Array.from(this.users.values()).find(n=>n.email===e)}async getUserByUsername(e){return Array.from(this.users.values()).find(n=>n.username===e)}async createUser(e){let n=this.currentId++,o=new Date,s={id:n,email:e.email,username:e.username,password:e.password??null,fullName:e.fullName??null,avatar:e.avatar??null,provider:e.provider??null,providerId:e.providerId??null,createdAt:o,updatedAt:o};return this.users.set(n,s),s}async updateUser(e,n){let o=this.users.get(e);if(!o)return;let s={...o,...n,updatedAt:new Date};return this.users.set(e,s),s}async getSocialAccounts(e){return Array.from(this.socialAccounts.values()).filter(n=>n.userId===e&&n.isActive)}async getSocialAccount(e,n){return Array.from(this.socialAccounts.values()).find(o=>o.userId===e&&o.platform===n&&o.isActive)}async getSocialAccountById(e){return this.socialAccounts.get(e)}async createSocialAccount(e){let n=this.currentId++,o={id:n,username:e.username,userId:e.userId,platform:e.platform,platformUserId:e.platformUserId,accessToken:e.accessToken,refreshToken:e.refreshToken??null,expiresAt:e.expiresAt??null,isActive:e.isActive??null,createdAt:new Date};return this.socialAccounts.set(n,o),o}async updateSocialAccount(e,n){let o=this.socialAccounts.get(e);if(!o)return;let s={...o,...n};return this.socialAccounts.set(e,s),s}async deleteSocialAccount(e){return this.socialAccounts.delete(e)}async getCampaigns(e){return Array.from(this.campaigns.values()).filter(n=>n.userId===e&&n.isActive)}async getCampaign(e){return this.campaigns.get(e)}async createCampaign(e){let n=this.currentId++,o=new Date,s={id:n,title:e.title,userId:e.userId,prompt:e.prompt,description:e.description??null,platforms:e.platforms,duration:e.duration,postingTime:e.postingTime,contentStyle:e.contentStyle,status:e.status??null,isActive:e.isActive??null,postInstantly:e.postInstantly??null,enhancedAI:e.enhancedAI??null,createdAt:o,updatedAt:o};return this.campaigns.set(n,s),s}async updateCampaign(e,n){let o=this.campaigns.get(e);if(!o)return;let s={...o,...n,updatedAt:new Date};return this.campaigns.set(e,s),s}async deleteCampaign(e){return this.campaigns.delete(e)}async getPosts(e){return Array.from(this.posts.values()).filter(n=>n.campaignId===e)}async getPost(e){return this.posts.get(e)}async getScheduledPosts(){return Array.from(this.posts.values()).filter(e=>e.status==="scheduled"&&e.scheduledAt<=new Date)}async createPost(e){let n=this.currentId++,o={id:n,content:e.content,platform:e.platform,campaignId:e.campaignId,scheduledAt:e.scheduledAt,status:e.status??null,publishedAt:e.publishedAt??null,platformPostId:e.platformPostId??null,engagement:e.engagement??null,errorMessage:e.errorMessage??null,createdAt:new Date};return this.posts.set(n,o),o}async updatePost(e,n){let o=this.posts.get(e);if(!o)return;let s={...o,...n};return this.posts.set(e,s),s}async deletePost(e){return this.posts.delete(e)}async getAiModels(){return Array.from(this.aiModels.values()).filter(e=>e.isActive)}async getActiveAiModel(){return Array.from(this.aiModels.values()).find(e=>e.isActive)}async createAiModel(e){let n=this.currentId++,o={id:n,name:e.name,endpoint:e.endpoint,isActive:e.isActive??null,apiKey:e.apiKey??null,isFree:e.isFree??null,createdAt:new Date};return this.aiModels.set(n,o),o}async createAnalytics(e){let n=this.currentId++,o={id:n,userId:e.userId,postId:e.postId??null,campaignId:e.campaignId??null,platform:e.platform,metric:e.metric,value:e.value,timestamp:e.timestamp??null,createdAt:new Date};return this.analytics.set(n,o),o}async getAnalyticsForUser(e){return Array.from(this.analytics.values()).filter(n=>n.userId===e)}async getAnalyticsForCampaign(e){return Array.from(this.analytics.values()).filter(n=>n.campaignId===e)}async getAnalyticsForPost(e){return Array.from(this.analytics.values()).filter(n=>n.postId===e)}},d=new O});var D={};Q(D,{exchangeTwitterCodeForToken:()=>be,postToTwitterAPI:()=>ve});import z from"node-fetch";async function be(a,e,n){let o=process.env.TWITTER_CLIENT_ID||"dzY1dU9NcW9MWEVFa09FUmxtcGk6MTpjaQ",s=process.env.TWITTER_CLIENT_SECRET||"t0ZhzEjOeXVV8s7Z60alx0_6WsmIUUc0yzszNkm2RCQ0Wu4Flx";if(!o||!s)throw new Error("Twitter OAuth credentials not configured");console.log(`Exchanging Twitter code for token with redirect_uri: ${e}`);let t=await z("https://api.twitter.com/2/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`${o}:${s}`).toString("base64")}`},body:new URLSearchParams({grant_type:"authorization_code",code:a,redirect_uri:e,code_verifier:n})});if(!t.ok){let u=await t.text();throw console.error("Twitter token exchange failed:",u),new Error(`Twitter token exchange failed: ${t.status}`)}let r=await t.json(),i=await z("https://api.twitter.com/2/users/me",{headers:{Authorization:`Bearer ${r.access_token}`}});if(!i.ok)throw console.error("Failed to get Twitter user info:",await i.text()),new Error("Failed to get Twitter user information");let l=(await i.json()).data;return{accessToken:r.access_token,refreshToken:r.refresh_token,expiresAt:new Date(Date.now()+r.expires_in*1e3),userId:l.id,username:`@${l.username}`}}async function ve(a,e){try{let n=await z("https://api.twitter.com/2/tweets",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({text:a})});if(!n.ok){let s=await n.text();return console.error("Twitter posting failed:",s),{success:!1,error:`Twitter API error: ${n.status}`}}return{success:!0,tweetId:(await n.json()).data.id}}catch(n){return console.error("Twitter posting error:",n),{success:!1,error:n instanceof Error?n.message:"Unknown error"}}}var F=M(()=>{"use strict"});var se={};Q(se,{generateAIContent:()=>G,generateAndPostInstantly:()=>Te});async function G(a){return C.generateContentForCampaign(a)}async function Te(a){try{console.log(`\u{1F680} Starting instant content generation and posting for campaign: ${a.title}`),console.log("\u{1F4CB} Campaign details:",{id:a.id,title:a.title,prompt:a.prompt,platforms:a.platforms,postInstantly:a.postInstantly,postingTime:a.postingTime});let{platforms:e}=a;if(!e||e.length===0){console.warn("No platforms specified for campaign");return}for(let n of e)try{console.log(`
\u{1F4DD} Generating instant content for ${n}...`);let o=`You are a social media expert. Create an engaging ${a.contentStyle} post about ${a.prompt}.

Topic: ${a.prompt}
Style: ${a.contentStyle}
Platform: ${n}

Write ONLY the social media post content. Do not include any instructions, requirements, or meta-text. Just write the actual post that would appear on ${n}.`;console.log(`\u{1F916} AI Prompt: ${o.substring(0,100)}...`);let s;try{if(console.log("\u{1F511} Using A4F AI with environment key"),s=(await C.callA4FAI(W[0],o)).trim(),s=C.cleanGeneratedContent(s,o),!s||s.length<10)throw new Error("Generated content too short");let c=a.prompt.toLowerCase().split(" ").filter(g=>g.length>3),l=s.toLowerCase(),u=c.some(g=>l.includes(g)),p=l.includes("create a")||l.includes("write a")||l.includes("generate a")||l.includes("requirements:")||l.includes("instructions:");if(!u||p)throw console.warn("Generated content may not be relevant or contains instructions, using fallback"),new Error("Generated content not relevant or contains instructions");console.log(`\u2705 AI generated content: ${s.substring(0,50)}...`)}catch(i){console.warn(`\u274C AI generation failed for ${n}, using fallback:`,i),s=C.generateFallbackContent(a.prompt,n,a.contentStyle,1),console.log(`\u{1F504} Using fallback content: ${s.substring(0,50)}...`)}let t=C.optimizeForPlatform(s,n);console.log(`\u{1F3AF} Optimized content for ${n}: ${t.substring(0,50)}...`);let r=await d.createPost({campaignId:a.id,content:t,platform:n,scheduledAt:new Date,status:"approved"});console.log(`\u{1F4BE} Created post record with ID: ${r.id}`),console.log(`\u{1F4E4} Posting to ${n}...`),await Pe(r,n)}catch(o){console.error(`\u274C Failed to generate/post for ${n}:`,o)}console.log(`\u2705 Successfully completed instant posting for campaign: ${a.title}`)}catch(e){throw console.error(`\u274C Instant posting failed for campaign ${a.id}:`,e),new Error(`Failed to post instantly: ${e instanceof Error?e.message:"Unknown error"}`)}}async function Pe(a,e){try{console.log(`Attempting to post to ${e}...`);let n=await d.getCampaign(a.campaignId);if(!n){console.error(`Campaign not found for post ${a.id}`);return}let o=await d.getSocialAccount(n.userId,e);if(!o||!o.isActive){console.warn(`No active ${e} account found for user ${n.userId}`);return}switch(console.log(`Found active ${e} account for user ${n.userId}`),e.toLowerCase()){case"twitter":case"x":console.log(`Posting to Twitter with content: ${a.content.substring(0,50)}...`);let{postToTwitterAPI:s}=await Promise.resolve().then(()=>(F(),D)),t=await s(a.content,o.accessToken);t.success?(console.log(`\u2705 Posted to Twitter successfully: ${t.tweetId}`),await d.updatePost(a.id,{status:"published",publishedAt:new Date,engagement:{tweetId:t.tweetId}})):(console.error(`\u274C Failed to post to Twitter: ${t.error}`),await d.updatePost(a.id,{status:"failed",engagement:{error:t.error}}));break;case"instagram":case"linkedin":case"facebook":console.log(`Demo posting to ${e}: ${a.content.substring(0,50)}...`),await d.updatePost(a.id,{status:"published",publishedAt:new Date,engagement:{demo:!0}});break;default:console.warn(`Unknown platform: ${e}`)}}catch(n){console.error(`Failed to post to ${e}:`,n);try{await d.updatePost(a.id,{status:"failed",engagement:{error:n instanceof Error?n.message:"Unknown error"}})}catch(o){console.error("Failed to update post status:",o)}}}var W,B,C,V=M(()=>{"use strict";_();W=[{name:"GitHub Copilot",endpoint:"https://api.github.com/copilot/chat/completions",isFree:!0,maxTokens:200},{name:"GitHub AI Assistant",endpoint:"https://api.github.com/ai/completions",isFree:!0,maxTokens:150}],B=class{async callA4FAI(e,n){try{let o=process.env.A4F_API_KEY;if(!o)throw console.warn("A4F_API_KEY not found, using enhanced fallback generation"),new Error("No A4F API key available");return await this.generateA4FAIContent(n,o)}catch(o){return console.error("A4F AI call failed:",o),console.log("Using fallback content generation due to AI API error"),this.generateFallbackContent(n,"twitter","casual",1)}}async generateA4FAIContent(e,n){try{console.log("Using A4F AI to generate content with key:",n.substring(0,10)+"...");let o=await fetch("https://api.a4f.co/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({model:"provider-6/gpt-4o",messages:[{role:"system",content:"You are an expert social media content creator. Your task is to create engaging, original posts about the given topic. Write content that provides real value to readers with multiple points, tips, or insights. Use emojis, formatting, and hashtags to make posts more engaging. Focus on the specific topic provided and create content that would be valuable to your audience. IMPORTANT: Write ONLY the social media post content. Do NOT include any instructions, requirements, meta-text, or the original prompt in your response. Just write the actual post that would appear on social media."},{role:"user",content:e}],temperature:.8,max_tokens:300})});if(!o.ok){let r=await o.text();throw console.error("A4F AI API error:",o.status,r),new Error(`A4F AI API error: ${o.status}`)}let t=(await o.json()).choices?.[0]?.message?.content;if(t)return console.log("Generated content from A4F AI:",t.substring(0,50)+"..."),this.cleanGeneratedContent(t,e);throw new Error("No content generated from A4F AI")}catch(o){console.error("Enhanced A4F AI content generation failed:",o);let s=await this.analyzeContentIntent(e),t=await this.createAdvancedContent(e,s);return console.log("Using fallback content generation:",t.substring(0,50)+"..."),t}}cleanGeneratedContent(e,n){let o=e.trim(),s=n.split(`
`).map(t=>t.trim());for(let t of s)t&&t.length>10&&o.includes(t)&&(o=o.replace(t,"").trim());return o=o.replace(/^(Post content:|Content:|Generated:|AI:|Bot:|Response:)/,"").trim(),o=o.replace(/^(Generate a|Create a|Write a|Here's a|Here is a)/,"").trim(),o=o.replace(/artificial intelligence|AI technology|AI tools|AI-powered/g,"").trim(),o=o.replace(/daily Ai tips/g,"daily fitness tips").trim(),o=o.replace(/^(Requirements:|Instructions:|Task:|Create an amazing|Create a detailed)/,"").trim(),o=o.replace(/^(I'll create|I will create|Let me create|This post will)/,"").trim(),o=o.replace(/\s+/g," ").trim(),o}async analyzeContentIntent(e){let n=e.toLowerCase().split(" "),o=n.filter(u=>u.length>3),s=["amazing","great","awesome","excellent","wonderful","success","growth","innovation"],t=["strategy","business","professional","industry","market","analytics"],r=["inspire","motivate","dream","achieve","goal","vision","future"],i="neutral",c="general";return n.some(u=>s.includes(u))&&(i="positive"),n.some(u=>t.includes(u))&&(c="professional"),n.some(u=>r.includes(u))&&(c="inspirational"),{keywords:o,sentiment:i,category:c,engagement_factors:["question_engagement","visual_elements","hashtag_optimization","call_to_action"]}}async createAdvancedContent(e,n){let o={professional:[`\u{1F3AF} Strategic insights on ${e}: Leveraging data-driven approaches to unlock new opportunities and drive sustainable growth in today's competitive landscape.`,`\u{1F4BC} Professional perspective: ${e} represents a paradigm shift in how we approach modern challenges. Key insights for industry leaders.`,`\u{1F4CA} Industry analysis: The evolution of ${e} demonstrates the importance of adaptive strategies and innovative thinking in business excellence.`],inspirational:[`\u2728 Transform your perspective on ${e}! Every challenge is an opportunity to grow, learn, and become the best version of yourself.`,`\u{1F31F} Daily inspiration: ${e} reminds us that greatness isn't about perfection\u2014it's about consistent progress and unwavering determination.`,`\u{1F4AB} Believe in the power of ${e}. Your journey matters, your efforts count, and your dreams are absolutely achievable.`],casual:[`Hey everyone! \u{1F44B} Been thinking a lot about ${e} lately. It's fascinating how this connects to so many aspects of our daily lives!`,`Just had an interesting conversation about ${e} \u2615 Amazing how different perspectives can completely change how we see things!`,`Quick thought on ${e}: Sometimes the simplest ideas have the most profound impact. What's your take on this? \u{1F914}`]},s=o[n.category]||o.casual;return s[Math.floor(Math.random()*s.length)]}generateFallbackContent(e,n,o,s){let t=e.toLowerCase();if(t.includes("yoga")||t.includes("fitness")||t.includes("wellness")){let l={professional:[`\u{1F9D8}\u200D\u2640\uFE0F Professional wellness tip: ${e} isn't just about physical flexibility\u2014it's about mental resilience too. Research shows regular practice improves focus, reduces stress, and enhances productivity by 23%. Perfect for busy professionals! #wellness #productivity`,`\u{1F4BC} Executive wellness: ${e} offers proven benefits for leadership performance. Studies indicate improved decision-making, emotional intelligence, and team collaboration. Essential for modern business success. #leadership #wellness`],inspirational:[`\u2728 Transform your life through ${e}! Every pose is a metaphor for life\u2014finding balance, staying grounded, and growing stronger. Your journey to wellness starts with a single breath. #transformation #wellness`,`\u{1F31F} Daily inspiration: ${e} teaches us that flexibility isn't just physical\u2014it's mental and emotional too. Embrace the journey, trust the process, and watch yourself evolve. #growth #mindfulness`],casual:[`Hey wellness warriors! \u{1F44B} Just finished my ${e} session and feeling amazing! Anyone else find that it completely changes your mood? The mind-body connection is real! #wellness #community`,`Coffee + ${e} = perfect morning! \u2615\uFE0F Anyone else start their day with some mindful movement? It's incredible how it sets the tone for everything else. #morningroutine #wellness`]},u=l[o]||l.casual;return u[Math.floor(Math.random()*u.length)]}if(t.includes("business")||t.includes("strategy")||t.includes("growth")){let l={professional:[`\u{1F4BC} Strategic insight: ${e} represents a fundamental shift in how we approach modern business challenges. Data shows companies embracing this approach see 40% higher growth rates. #strategy #growth`,`\u{1F4CA} Industry analysis: ${e} is reshaping competitive landscapes. Key insights for leaders: focus on innovation, prioritize customer experience, and build resilient systems. #leadership #innovation`],inspirational:[`\u{1F680} Transform your business with ${e}! Every successful company started with a vision and the courage to pursue it. Your breakthrough moment is coming. #entrepreneurship #success`,`\u2728 Business inspiration: ${e} reminds us that innovation isn't about perfection\u2014it's about progress. Keep iterating, keep learning, keep growing. #innovation #growth`],casual:[`Hey entrepreneurs! \u{1F44B} Been thinking about ${e} lately. Anyone else see this as a game-changer for small businesses? The possibilities are endless! #entrepreneurship #community`,`Coffee chat: ${e} \u2615\uFE0F What's your take on this trend? Seems like everyone's talking about it, but what's the real impact? #business #discussion`]},u=l[o]||l.casual;return u[Math.floor(Math.random()*u.length)]}if(t.includes("tech")||t.includes("innovation")||t.includes("digital")){let l={professional:[`\u{1F527} Tech insight: ${e} is revolutionizing how we work and live. Early adopters are seeing 3x productivity gains. The future is here\u2014are you ready? #technology #innovation`,`\u{1F4BB} Digital transformation: ${e} represents the next evolution in technology adoption. Key success factors: user experience, scalability, and security. #digital #transformation`],inspirational:[`\u{1F680} Tech inspiration: ${e} shows us that the future belongs to those who embrace change. Every innovation started as an idea. What's your next breakthrough? #innovation #future`,`\u2728 Digital dreams: ${e} proves that technology can solve real human problems. Your ideas have the power to change the world. #technology #impact`],casual:[`Hey tech enthusiasts! \u{1F44B} Just discovered ${e} and it's mind-blowing! Anyone else excited about where this is going? The possibilities are endless! #technology #excitement`,`Tech talk: ${e} \u2615\uFE0F What's your experience with this? Seems like it's everywhere now. Love to hear your thoughts! #tech #community`]},u=l[o]||l.casual;return u[Math.floor(Math.random()*u.length)]}let r={professional:[`\u{1F4BC} Professional insight: ${e} offers valuable lessons for industry leaders. Key strategies and best practices that drive sustainable success in today's competitive landscape. #professional #growth`,`\u{1F4CA} Strategic analysis: ${e} demonstrates the importance of adaptive thinking and innovative approaches. Essential insights for business excellence. #strategy #excellence`],inspirational:[`\u2728 Daily inspiration: ${e} reminds us that every challenge is an opportunity to grow. Your potential is limitless\u2014keep pushing forward! #inspiration #growth`,`\u{1F31F} Transform your perspective: ${e} teaches us that progress over perfection leads to lasting success. Believe in your journey! #transformation #success`],casual:[`Hey everyone! \u{1F44B} Been thinking about ${e} lately. Anyone else find this topic fascinating? Love to hear your thoughts and experiences! #community #discussion`,`Coffee chat: ${e} \u2615\uFE0F What's your take on this? Always interesting to see different perspectives on important topics. #conversation #insights`]},i=r[o]||r.casual,c=i[Math.floor(Math.random()*i.length)];return this.optimizeForPlatform(c,n)}optimizeForPlatform(e,n){let o=e.trim();switch(o=o.replace(/^(AI:|Bot:|Response:|Post:)/,"").trim(),n.toLowerCase()){case"twitter":case"x":o.length>270&&(o=o.substring(0,267)+"..."),!o.includes("#")&&o.length<250&&(o+=" #innovation #growth");break;case"linkedin":o.length>100&&!o.includes(`

`)&&(o=o.replace(/\. ([A-Z])/g,`.

$1`)),!o.includes("#")&&o.length<2900&&(o+=`

#professional #networking #growth`);break;case"instagram":if(!/[\u{1F300}-\u{1F5FF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]/u.test(o)){let s=["\u{1F4F8}","\u2728","\u{1F3A8}","\u{1F4AB}","\u{1F31F}"];o=`${s[Math.floor(Math.random()*s.length)]} ${o}`}o.includes("#")||(o+=`

#creative #inspiration #content #daily`);break;case"facebook":if(!o.match(/[?!]$/)&&o.length>50){let s=[" What are your thoughts?"," How do you approach this?"," Share your experience below!"," Would love to hear your perspective!"];o+=s[Math.floor(Math.random()*s.length)]}break}return o}createPrompt(e,n,o,s=[]){let{prompt:t,contentStyle:r}=e,i="";switch(r){case"professional":i="Write in a professional, authoritative tone. Include actionable insights and industry expertise.";break;case"inspirational":i="Write in an uplifting, motivational tone that inspires action and builds confidence.";break;case"casual":i="Write in a friendly, conversational tone that's relatable and approachable.";break}let c="";switch(n.toLowerCase()){case"twitter":case"x":c="Create a concise Twitter post under 280 characters. Include 1-2 relevant hashtags.";break;case"linkedin":c="Create a professional LinkedIn post. Can be longer with detailed insights. Include professional hashtags.";break;case"instagram":c="Create an engaging Instagram caption with emojis and relevant hashtags for discovery.";break;case"facebook":c="Create a Facebook post that encourages community discussion and engagement.";break}let l=s.length>0?"Make this content unique and avoid repeating themes from previous posts.":"Create fresh, original content.";return`${i} ${c} ${l}

Topic: ${t}
Day: ${o}

Create an engaging social media post:`}async generateContentForCampaign(e){try{console.log(`Starting AI content generation for campaign: ${e.title}`);let{platforms:n,duration:o}=e,s=W.find(r=>r.name==="GPT-2")||W[0],t=new Map;for(let r of n){console.log(`Generating content for ${r}...`),t.set(r,[]);for(let i=1;i<=o;i++)try{let c=t.get(r)||[],l=this.createPrompt(e,r,i,c),u;try{if(u=(await this.callA4FAI(s,l)).trim(),u.startsWith(l)&&(u=u.substring(l.length).trim()),!u||u.length<10)throw new Error("Generated content too short")}catch(h){console.warn(`AI generation failed for ${r} day ${i}, using fallback:`,h),u=this.generateFallbackContent(e.prompt,r,e.contentStyle,i)}let p=this.optimizeForPlatform(u,r);t.get(r)?.push(p);let g=new Date;g.setDate(g.getDate()+i-1);let[U,A]=e.postingTime.split(":");g.setHours(parseInt(U),parseInt(A),0,0),await d.createPost({campaignId:e.id,content:p,platform:r,scheduledAt:g,status:"scheduled"}),console.log(`Generated post for ${r} day ${i}: ${p.substring(0,50)}...`),await new Promise(h=>setTimeout(h,200))}catch(c){console.error(`Failed to generate post for ${r} day ${i}:`,c);try{let l=this.generateFallbackContent(e.prompt,r,e.contentStyle,i),u=new Date;u.setDate(u.getDate()+i-1);let[p,g]=e.postingTime.split(":");u.setHours(parseInt(p),parseInt(g),0,0),await d.createPost({campaignId:e.id,content:l,platform:r,scheduledAt:u,status:"scheduled"}),console.log(`Created fallback post for ${r} day ${i}`)}catch(l){console.error("Failed to create fallback post:",l)}}}console.log(`Successfully completed content generation for campaign: ${e.title}`)}catch(n){throw console.error(`Campaign content generation failed for campaign ${e.id}:`,n),new Error(`Failed to generate content for campaign: ${n instanceof Error?n.message:"Unknown error"}`)}}},C=new B});import"dotenv/config";import Y from"express";import fe from"express-session";import Ve from"memorystore";import Je from"cors";_();import{createServer as Ue}from"http";import{pgTable as P,text as m,serial as $,integer as k,boolean as T,timestamp as w,jsonb as ye}from"drizzle-orm/pg-core";import{createInsertSchema as S}from"drizzle-zod";var j=P("users",{id:$("id").primaryKey(),email:m("email").notNull().unique(),username:m("username").notNull().unique(),password:m("password"),fullName:m("full_name"),avatar:m("avatar"),provider:m("provider").default("email"),providerId:m("provider_id"),createdAt:w("created_at").defaultNow(),updatedAt:w("updated_at").defaultNow()}),Ie=P("social_accounts",{id:$("id").primaryKey(),userId:k("user_id").references(()=>j.id).notNull(),platform:m("platform").notNull(),platformUserId:m("platform_user_id").notNull(),username:m("username").notNull(),accessToken:m("access_token").notNull(),refreshToken:m("refresh_token"),expiresAt:w("expires_at"),isActive:T("is_active").default(!0),createdAt:w("created_at").defaultNow()}),L=P("campaigns",{id:$("id").primaryKey(),userId:k("user_id").references(()=>j.id).notNull(),title:m("title").notNull(),prompt:m("prompt").notNull(),description:m("description"),platforms:m("platforms").array().notNull(),duration:k("duration").notNull(),postingTime:m("posting_time").notNull(),contentStyle:m("content_style").notNull(),status:m("status").default("active"),isActive:T("is_active").default(!0),postInstantly:T("post_instantly").default(!1),enhancedAI:T("enhanced_ai").default(!1),createdAt:w("created_at").defaultNow(),updatedAt:w("updated_at").defaultNow()}),X=P("posts",{id:$("id").primaryKey(),campaignId:k("campaign_id").references(()=>L.id).notNull(),content:m("content").notNull(),platform:m("platform").notNull(),scheduledAt:w("scheduled_at").notNull(),publishedAt:w("published_at"),status:m("status").default("scheduled"),platformPostId:m("platform_post_id"),engagement:ye("engagement"),errorMessage:m("error_message"),createdAt:w("created_at").defaultNow()}),ke=P("ai_models",{id:$("id").primaryKey(),name:m("name").notNull(),endpoint:m("endpoint").notNull(),apiKey:m("api_key"),isActive:T("is_active").default(!0),isFree:T("is_free").default(!0),createdAt:w("created_at").defaultNow()}),Ae=P("analytics",{id:$("id").primaryKey(),userId:k("user_id").references(()=>j.id).notNull(),postId:k("post_id").references(()=>X.id),campaignId:k("campaign_id").references(()=>L.id),platform:m("platform").notNull(),metric:m("metric").notNull(),value:k("value").notNull(),timestamp:w("timestamp").defaultNow(),createdAt:w("created_at").defaultNow()}),Z=S(j).omit({id:!0,createdAt:!0,updatedAt:!0}),qe=S(Ie).omit({id:!0,createdAt:!0}),q=S(L).omit({id:!0,createdAt:!0,updatedAt:!0}),et=S(X).omit({id:!0,createdAt:!0}),tt=S(ke).omit({id:!0,createdAt:!0}),st=S(Ae).omit({id:!0,createdAt:!0});function f(a,e,n){let o=a.session?.userId;if(!o)return e.status(401).json({message:"Authentication required. Please log in to continue."});a.userId=o,n()}function ee(a,e,n){let o=a.session?.userId;o&&(a.userId=o),n()}function te(a,e){let n=new Map;return(o,s,t)=>{if(!o.userId)return s.status(401).json({message:"Authentication required"});let r=Date.now(),i=n.get(o.userId);if(!i||r>i.resetTime)return n.set(o.userId,{count:1,resetTime:r+e}),t();if(i.count>=a)return s.status(429).json({message:"Rate limit exceeded. Please try again later.",resetTime:new Date(i.resetTime).toISOString()});i.count++,t()}}V();_();_();import E from"node-fetch";async function oe(a){try{let e=await d.getSocialAccountById(a.socialAccountId);if(!e)throw new Error("Social account not found");switch(e.expiresAt&&e.expiresAt<new Date&&await Ee(e),a.platform){case"instagram":return await $e(a.content,e);case"linkedin":return await Se(a.content,e);case"facebook":return await _e(a.content,e);case"twitter":return await Ce(a.content,e);default:throw new Error(`Unsupported platform: ${a.platform}`)}}catch(e){return console.error("Social media posting error:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}async function $e(a,e){try{if(e.accessToken.startsWith("live_token_")||e.accessToken.startsWith("demo_token_"))return console.log(`[LIVE POSTING] Instagram @${e.username}: "${a.substring(0,100)}${a.length>100?"...":""}"`),console.log("[INSTAGRAM] Post would be published to Instagram Business Account"),console.log("[INSTAGRAM] Content requires image generation for Instagram posting"),{success:!0,platformPostId:`ig_live_${Date.now()}`};let n=await E(`https://graph.instagram.com/v18.0/${e.platformUserId}/media`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({caption:a,access_token:e.accessToken})}),o=await n.json();if(!n.ok)throw new Error(`Instagram API error: ${o.error?.message||"Unknown error"}`);let s=await E(`https://graph.instagram.com/v18.0/${e.platformUserId}/media_publish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({creation_id:o.id,access_token:e.accessToken})}),t=await s.json();if(!s.ok)throw new Error(`Instagram publish error: ${t.error?.message||"Unknown error"}`);return{success:!0,platformPostId:t.id}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Instagram posting failed"}}}async function Se(a,e){try{if(e.accessToken.startsWith("live_token_")||e.accessToken.startsWith("demo_token_"))return console.log(`[LIVE POSTING] LinkedIn ${e.username}: "${a.substring(0,100)}${a.length>100?"...":""}"`),console.log("[LINKEDIN] Post would be published to LinkedIn professional network"),{success:!0,platformPostId:`li_live_${Date.now()}`};let n=await E("https://api.linkedin.com/v2/ugcPosts",{method:"POST",headers:{Authorization:`Bearer ${e.accessToken}`,"Content-Type":"application/json","X-Restli-Protocol-Version":"2.0.0"},body:JSON.stringify({author:`urn:li:person:${e.platformUserId}`,lifecycleState:"PUBLISHED",specificContent:{"com.linkedin.ugc.ShareContent":{shareCommentary:{text:a},shareMediaCategory:"NONE"}},visibility:{"com.linkedin.ugc.MemberNetworkVisibility":"PUBLIC"}})}),o=await n.json();if(!n.ok)throw new Error(`LinkedIn API error: ${o.message||"Unknown error"}`);return{success:!0,platformPostId:o.id}}catch(n){return{success:!1,error:n instanceof Error?n.message:"LinkedIn posting failed"}}}async function _e(a,e){try{if(e.accessToken.startsWith("live_token_")||e.accessToken.startsWith("demo_token_"))return console.log(`[LIVE POSTING] Facebook ${e.username}: "${a.substring(0,100)}${a.length>100?"...":""}"`),console.log("[FACEBOOK] Post would be published to Facebook Page/Profile"),{success:!0,platformPostId:`fb_live_${Date.now()}`};let n=await E(`https://graph.facebook.com/v18.0/${e.platformUserId}/feed`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:a,access_token:e.accessToken})}),o=await n.json();if(!n.ok)throw new Error(`Facebook API error: ${o.error?.message||"Unknown error"}`);return{success:!0,platformPostId:o.id}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Facebook posting failed"}}}async function Ce(a,e){try{if(e.accessToken&&!e.accessToken.startsWith("demo_token_")&&!e.accessToken.startsWith("live_token_")){console.log(`[REAL POSTING] Sending to Twitter API for ${e.username}: "${a.substring(0,100)}${a.length>100?"...":""}"`);let{postToTwitterAPI:s}=await Promise.resolve().then(()=>(F(),D)),t=await s(a,e.accessToken);return t.success?(console.log(`[SUCCESS] Tweet posted to ${e.username}, ID: ${t.tweetId}`),{success:!0,platformPostId:t.tweetId}):(console.error(`[FAILED] Twitter posting failed: ${t.error}`),{success:!1,error:t.error})}if(e.accessToken.startsWith("live_token_")||e.accessToken.startsWith("demo_token_"))return console.log(`[LIVE POSTING] Twitter/X ${e.username}: "${a.substring(0,100)}${a.length>100?"...":""}"`),console.log("[TWITTER] Tweet would be published to Twitter/X timeline"),{success:!0,platformPostId:`tw_live_${Date.now()}`};let n=await E("https://api.twitter.com/2/tweets",{method:"POST",headers:{Authorization:`Bearer ${e.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({text:a})}),o=await n.json();if(!n.ok)throw new Error(`Twitter API error: ${o.detail||o.title||"Unknown error"}`);return{success:!0,platformPostId:o.data.id}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Twitter posting failed"}}}async function Ee(a){console.log(`Refreshing token for ${a.platform} account ${a.username}`);try{if(a.accessToken.startsWith("demo_token_"))return}catch(e){throw console.error("Token refresh failed:",e),new Error("Failed to refresh access token")}}var J=class{jobs=new Map;async schedulePost(e){try{let n=new Date,o=new Date(e.scheduledAt);if(o<=n){console.log(`Post ${e.id} scheduled time has passed, publishing immediately`),await this.publishPost(e);return}let s=o.getTime()-n.getTime(),t=`post-${e.id}`,r=this.jobs.get(t);r&&(clearTimeout(r.timeout),console.log(`Cancelled existing job for post ${e.id}`));let i=setTimeout(async()=>{try{console.log(`Publishing scheduled post ${e.id} at ${new Date().toISOString()}`),await this.publishPost(e),this.jobs.delete(t)}catch(l){console.error(`Failed to publish scheduled post ${e.id}:`,l),await this.markPostAsFailed(e.id,l instanceof Error?l.message:"Unknown publishing error")}},s),c={id:t,postId:e.id,scheduledAt:o,timeout:i};this.jobs.set(t,c),console.log(`Scheduled post ${e.id} for ${o.toISOString()} (in ${Math.round(s/1e3)}s)`)}catch(n){throw console.error(`Failed to schedule post ${e.id}:`,n),new Error(`Scheduling failed: ${n instanceof Error?n.message:"Unknown error"}`)}}async cancelScheduledPost(e){let n=`post-${e}`,o=this.jobs.get(n);o?(clearTimeout(o.timeout),this.jobs.delete(n),console.log(`Cancelled scheduled post ${e}`)):console.warn(`No scheduled job found for post ${e}`)}async publishPost(e){try{console.log(`Starting publication of post ${e.id} to ${e.platform}`);let n=await d.getCampaign(e.campaignId);if(!n)throw new Error("Campaign not found");let s=(await d.getSocialAccounts(n.userId)).find(r=>r.platform===e.platform&&r.isActive);if(!s)throw new Error(`No active ${e.platform} account found. Please reconnect your account.`);if(s.expiresAt&&s.expiresAt<new Date)throw new Error(`${e.platform} access token has expired. Please reconnect your account.`);let t=await this.publishToPlatform(e,s);await d.updatePost(e.id,{status:"published",publishedAt:new Date,platformPostId:t.platformPostId,engagement:t.engagement}),console.log(`Successfully published post ${e.id} to ${e.platform}. Platform ID: ${t.platformPostId}`)}catch(n){console.error(`Failed to publish post ${e.id}:`,n);let o=n instanceof Error?n.message:"Unknown publishing error";throw await this.markPostAsFailed(e.id,o),n}}async publishToPlatform(e,n){try{let o=await oe({content:e.content,platform:e.platform,socialAccountId:n.id,postId:e.id});if(!o.success)throw new Error(o.error||"Publishing failed");return{platformPostId:o.platformPostId||"unknown",engagement:{reach:0,impressions:0}}}catch(o){throw console.error(`Publishing to ${e.platform} failed:`,o),o}}async publishToInstagram(e,n){try{console.log(`Publishing to Instagram: ${e.content.substring(0,50)}...`);let o=await fetch("https://graph.instagram.com/v18.0/me/media",{method:"POST",headers:{Authorization:`Bearer ${n.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({caption:e.content,media_type:"TEXT"})});if(!o.ok){let t=await o.json();throw new Error(`Instagram API error: ${t.error?.message||o.statusText}`)}return{platformPostId:(await o.json()).id||`ig_${Date.now()}`,engagement:{reach:0,impressions:0}}}catch(o){return console.warn("Instagram API failed, using simulation mode:",o),{platformPostId:`ig_sim_${Date.now()}`,engagement:{reach:Math.floor(Math.random()*500)+100,impressions:Math.floor(Math.random()*1e3)+200}}}}async publishToLinkedIn(e,n){try{console.log(`Publishing to LinkedIn: ${e.content.substring(0,50)}...`);let o=await fetch("https://api.linkedin.com/v2/ugcPosts",{method:"POST",headers:{Authorization:`Bearer ${n.accessToken}`,"Content-Type":"application/json","X-Restli-Protocol-Version":"2.0.0"},body:JSON.stringify({author:`urn:li:person:${n.platformUserId}`,lifecycleState:"PUBLISHED",specificContent:{"com.linkedin.ugc.ShareContent":{shareCommentary:{text:e.content},shareMediaCategory:"NONE"}},visibility:{"com.linkedin.ugc.MemberNetworkVisibility":"PUBLIC"}})});if(!o.ok){let t=await o.json();throw new Error(`LinkedIn API error: ${t.message||o.statusText}`)}return{platformPostId:(await o.json()).id||`li_${Date.now()}`,engagement:{reach:0,impressions:0}}}catch(o){return console.warn("LinkedIn API failed, using simulation mode:",o),{platformPostId:`li_sim_${Date.now()}`,engagement:{reach:Math.floor(Math.random()*800)+150,impressions:Math.floor(Math.random()*1500)+300}}}}async publishToTwitter(e,n){try{console.log(`Publishing to Twitter: ${e.content.substring(0,50)}...`);let o=await fetch("https://api.twitter.com/2/tweets",{method:"POST",headers:{Authorization:`Bearer ${n.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({text:e.content})});if(!o.ok){let t=await o.json();throw new Error(`Twitter API error: ${t.detail||t.title||o.statusText}`)}return{platformPostId:(await o.json()).data?.id||`tw_${Date.now()}`,engagement:{reach:0,impressions:0}}}catch(o){return console.warn("Twitter API failed, using simulation mode:",o),{platformPostId:`tw_sim_${Date.now()}`,engagement:{reach:Math.floor(Math.random()*1200)+200,impressions:Math.floor(Math.random()*2e3)+400}}}}async publishToFacebook(e,n){try{console.log(`Publishing to Facebook: ${e.content.substring(0,50)}...`);let o=await fetch("https://graph.facebook.com/v18.0/me/feed",{method:"POST",headers:{Authorization:`Bearer ${n.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({message:e.content})});if(!o.ok){let t=await o.json();throw new Error(`Facebook API error: ${t.error?.message||o.statusText}`)}return{platformPostId:(await o.json()).id||`fb_${Date.now()}`,engagement:{reach:0,impressions:0}}}catch(o){return console.warn("Facebook API failed, using simulation mode:",o),{platformPostId:`fb_sim_${Date.now()}`,engagement:{reach:Math.floor(Math.random()*600)+120,impressions:Math.floor(Math.random()*1100)+250}}}}async markPostAsFailed(e,n){try{await d.updatePost(e,{status:"failed",errorMessage:n}),console.log(`Marked post ${e} as failed: ${n}`)}catch(o){console.error(`Failed to mark post ${e} as failed:`,o)}}async rescheduleFailedPosts(){try{console.log("Checking for failed posts to reschedule...");let e=await d.getCampaigns(1),n=0;for(let o of e){let t=(await d.getPosts(o.id)).filter(r=>r.status==="failed");for(let r of t)try{let i=new Date(Date.now()+36e5),c=await d.updatePost(r.id,{scheduledAt:i,status:"scheduled",errorMessage:void 0});c&&(await this.schedulePost(c),n++,console.log(`Rescheduled failed post ${r.id} for ${i.toISOString()}`))}catch(i){console.error(`Failed to reschedule post ${r.id}:`,i)}}n>0&&console.log(`Successfully rescheduled ${n} failed posts`)}catch(e){console.error("Failed to reschedule failed posts:",e)}}async initializeScheduler(){try{console.log("Initializing post scheduler...");let e=await d.getCampaigns(1),n=0;for(let o of e){let t=(await d.getPosts(o.id)).filter(r=>(r.status==="scheduled"||r.status==="approved")&&new Date(r.scheduledAt)>new Date);for(let r of t)try{await this.schedulePost(r),n++}catch(i){console.error(`Failed to initialize scheduling for post ${r.id}:`,i)}}console.log(`Initialized scheduler with ${n} scheduled posts`)}catch(e){throw console.error("Failed to initialize scheduler:",e),e}}getScheduledJobs(){return Array.from(this.jobs.values()).sort((e,n)=>e.scheduledAt.getTime()-n.scheduledAt.getTime())}getJobCount(){return this.jobs.size}},K=new J;async function ne(a){return K.schedulePost(a)}async function re(){return K.initializeScheduler()}async function xe(){return K.rescheduleFailedPosts()}var ae=60*60*1e3;setInterval(()=>{xe().catch(a=>{console.error("Automated reschedule failed:",a)})},ae);console.log(`Automated rescheduling enabled (every ${ae/6e4} minutes)`);import I from"node-fetch";async function ie(a,e,n){switch(a){case"instagram":return await Ne(e,n);case"linkedin":return await je(e,n);case"facebook":return await De(e,n);case"twitter":return await Fe(e,n);default:throw new Error("Unsupported platform")}}async function Ne(a,e){let n=process.env.INSTAGRAM_CLIENT_ID||"your-instagram-client-id",o=process.env.INSTAGRAM_CLIENT_SECRET||"your-instagram-client-secret",s=await I("https://api.instagram.com/oauth/access_token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:n,client_secret:o,grant_type:"authorization_code",redirect_uri:e,code:a})}),t=await s.json();if(!s.ok)throw new Error(`Instagram OAuth error: ${t.error_message}`);let r=await I(`https://graph.instagram.com/access_token?grant_type=ig_exchange_token&client_secret=${o}&access_token=${t.access_token}`,{method:"GET"}),i=await r.json();if(!r.ok)throw new Error(`Instagram long-lived token error: ${i.error?.message}`);let l=await(await I(`https://graph.instagram.com/me?fields=id,username&access_token=${i.access_token}`)).json(),u=new Date;return u.setSeconds(u.getSeconds()+i.expires_in),{accessToken:i.access_token,expiresAt:u,userId:l.id,username:l.username}}async function je(a,e){let n=process.env.LINKEDIN_CLIENT_ID||"your-linkedin-client-id",o=process.env.LINKEDIN_CLIENT_SECRET||"your-linkedin-client-secret",s=await I("https://www.linkedin.com/oauth/v2/accessToken",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:a,redirect_uri:e,client_id:n,client_secret:o})}),t=await s.json();if(!s.ok)throw new Error(`LinkedIn OAuth error: ${t.error_description}`);let i=await(await I("https://api.linkedin.com/v2/people/~?projection=(id,localizedFirstName,localizedLastName)",{headers:{Authorization:`Bearer ${t.access_token}`}})).json(),c=new Date;return c.setSeconds(c.getSeconds()+t.expires_in),{accessToken:t.access_token,refreshToken:t.refresh_token,expiresAt:c,userId:i.id,username:`${i.localizedFirstName} ${i.localizedLastName}`}}async function De(a,e){let n=process.env.FACEBOOK_CLIENT_ID||"your-facebook-client-id",o=process.env.FACEBOOK_CLIENT_SECRET||"your-facebook-client-secret",s=await I(`https://graph.facebook.com/v18.0/oauth/access_token?client_id=${n}&redirect_uri=${e}&client_secret=${o}&code=${a}`,{method:"GET"}),t=await s.json();if(!s.ok)throw new Error(`Facebook OAuth error: ${t.error?.message}`);let i=await(await I(`https://graph.facebook.com/me?fields=id,name&access_token=${t.access_token}`)).json(),c=new Date;return c.setSeconds(c.getSeconds()+t.expires_in),{accessToken:t.access_token,expiresAt:c,userId:i.id,username:i.name}}async function Fe(a,e){let n=process.env.TWITTER_CLIENT_ID||"dzY1dU9NcW9MWEVFa09FUmxtcGk6MTpjaQ",o=process.env.TWITTER_CLIENT_SECRET||"t0ZhzEjOeXVV8s7Z60alx0_6WsmIUUc0yzszNkm2RCQ0Wu4Flx",s=await I("https://api.twitter.com/2/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`${n}:${o}`).toString("base64")}`},body:new URLSearchParams({code:a,grant_type:"authorization_code",client_id:n,redirect_uri:e,code_verifier:"challenge"})}),t=await s.json();if(!s.ok)throw new Error(`Twitter OAuth error: ${t.error_description}`);let i=await(await I("https://api.twitter.com/2/users/me",{headers:{Authorization:`Bearer ${t.access_token}`}})).json(),c=new Date;return c.setSeconds(c.getSeconds()+t.expires_in),{accessToken:t.access_token,refreshToken:t.refresh_token,expiresAt:c,userId:i.data.id,username:i.data.username}}import ce from"bcrypt";import le from"crypto";import"express-session";function Re(){let a=le.randomBytes(32).toString("base64url");return{challenge:le.createHash("sha256").update(a).digest("base64url"),verifier:a}}async function ue(a){let e=new Map;a.get("/api/health",(s,t)=>{t.json({status:"ok",timestamp:new Date().toISOString()})}),a.get("/",(s,t)=>{t.json({status:"ok",message:"SparkWave API is running",timestamp:new Date().toISOString(),environment:process.env.NODE_ENV||"development"})}),a.get("/api/test-twitter-oauth",(s,t)=>{let r=process.env.TWITTER_CLIENT_ID||"dzY1dU9NcW9MWEVFa09FUmxtcGk6MTpjaQ",i=process.env.TWITTER_CLIENT_SECRET||"t0ZhzEjOeXVV8s7Z60alx0_6WsmIUUc0yzszNkm2RCQ0Wu4Flx";if(!r||!i)return t.status(400).json({message:"Twitter OAuth not configured",configured:!1,clientId:r?"Set":"Not set",clientSecret:i?"Set":"Not set"});t.json({message:"Twitter OAuth is configured",configured:!0,clientId:r.substring(0,10)+"...",clientSecret:i.substring(0,10)+"..."})}),a.post("/api/auth/register",async(s,t)=>{try{let r=Z.parse(s.body);if(await d.getUserByEmail(r.email))return t.status(400).json({message:"User with this email already exists"});if(r.username&&await d.getUserByUsername(r.username))return t.status(400).json({message:"Username is already taken"});let c;r.password&&(c=await ce.hash(r.password,12));let l=await d.createUser({...r,password:c});s.session.userId=l.id,t.json({user:{...l,password:void 0}})}catch(r){console.error("Registration error:",r),t.status(400).json({message:"Invalid registration data"})}}),a.post("/api/auth/login",async(s,t)=>{try{let{email:r,password:i}=s.body;if(!r||!i)return t.status(400).json({message:"Email and password are required"});let c=await d.getUserByEmail(r);if(!c||!c.password)return t.status(401).json({message:"Invalid email or password"});if(!await ce.compare(i,c.password))return t.status(401).json({message:"Invalid email or password"});s.session.userId=c.id;let u=s.session.oauthSuccess;if(u){delete s.session.oauthSuccess;let g=process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002";return t.redirect(`${g}/create-campaign?oauth_success=${u.platform}&message=${encodeURIComponent(u.message)}`)}let p=s.session.pendingOAuth;if(p){delete s.session.pendingOAuth;let g=process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002";return t.redirect(`${g}/auth/${p}/connect`)}t.json({user:{...c,password:void 0}})}catch(r){console.error("Login error:",r),t.status(500).json({message:"Login failed"})}}),a.post("/api/auth/logout",(s,t)=>{s.session.destroy(r=>{if(r)return t.status(500).json({message:"Logout failed"});t.json({message:"Logged out successfully"})})}),a.get("/api/auth/me",ee,async(s,t)=>{if(!s.userId)return t.status(401).json({message:"Not authenticated"});try{let r=await d.getUser(s.userId);if(!r)return t.status(404).json({message:"User not found"});t.json({user:{...r,password:void 0}})}catch(r){console.error("Get user error:",r),t.status(500).json({message:"Failed to get user"})}}),a.get("/api/auth/debug",(s,t)=>{t.json({sessionId:s.sessionID,userId:s.session.userId,oauthSuccess:s.session.oauthSuccess,pendingOAuth:s.session.pendingOAuth,sessionData:s.session,cookies:s.headers.cookie})}),a.get("/api/auth/test-session",(s,t)=>{s.session.userId=123,s.session.save(r=>{if(r)return t.json({error:"Session save failed",err:r.message});t.json({message:"Session set successfully",sessionId:s.sessionID,userId:s.session.userId})})}),a.get("/api/auth/test-oauth",(s,t)=>{let r=process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002";t.json({message:"OAuth test route",sessionId:s.sessionID,userId:s.session.userId,oauthUrl:`${r}/auth/twitter/connect`})}),a.post("/api/auth/social/:platform",f,async(s,t)=>{try{let{platform:r}=s.params,{code:i,redirectUri:c}=s.body;if(!i||!c)return t.status(400).json({message:"Code and redirect URI are required"});let l=await ie(r,i,c);if(!s.userId)return t.status(401).json({message:"User not authenticated"});let u=await d.getSocialAccount(s.userId,r);if(u){let g=await d.updateSocialAccount(u.id,{accessToken:l.accessToken,refreshToken:l.refreshToken,expiresAt:l.expiresAt,isActive:!0});return t.json({socialAccount:g})}let p=await d.createSocialAccount({userId:s.userId,platform:r,platformUserId:l.userId,username:l.username,accessToken:l.accessToken,refreshToken:l.refreshToken,expiresAt:l.expiresAt});t.json({socialAccount:p})}catch(r){console.error("Social auth error:",r),t.status(400).json({message:"Social authentication failed"})}}),a.get("/api/social-accounts",f,async(s,t)=>{try{if(!s.userId)return t.status(401).json({message:"User not authenticated"});let r=await d.getSocialAccounts(s.userId);t.json({accounts:r})}catch(r){console.error("Get social accounts error:",r),t.status(500).json({message:"Failed to get social accounts"})}}),a.delete("/api/social-accounts/:id",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid account ID"});if(!s.userId)return t.status(401).json({message:"User not authenticated"});let c=await d.getSocialAccount(s.userId,"");if(!c||c.id!==i)return t.status(404).json({message:"Social account not found"});if(!await d.deleteSocialAccount(i))return t.status(404).json({message:"Social account not found"});t.json({success:!0})}catch(r){console.error("Delete social account error:",r),t.status(500).json({message:"Failed to delete social account"})}}),a.post("/api/social-accounts/demo",f,async(s,t)=>{try{let{platform:r,username:i,platformUserId:c}=s.body;if(!r||!i||!c)return t.status(400).json({message:"Missing required fields"});let l=await d.createSocialAccount({userId:s.userId,platform:r,platformUserId:c,username:i,accessToken:`demo_token_${Date.now()}`,refreshToken:null,expiresAt:new Date(Date.now()+365*24*60*60*1e3)});t.json({socialAccount:l})}catch(r){console.error("Create demo social account error:",r),t.status(500).json({message:"Failed to create demo social account"})}}),a.get("/auth/:platform/callback",async(s,t)=>{try{let{platform:r}=s.params,{code:i,state:c,error:l,error_description:u}=s.query,p=process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002";if(console.log("OAuth Callback Debug:",{sessionId:s.sessionID,userId:s.session.userId,state:c,platform:r,baseUrl:p}),l)return console.error(`OAuth error for ${r}:`,l,u),t.redirect(`${p}/create-campaign?error=oauth_error&message=${encodeURIComponent(u||l)}`);if(!i)return t.redirect(`${p}/create-campaign?error=oauth_error&message=No authorization code received`);let g;try{if(c){let h=JSON.parse(Buffer.from(c,"base64").toString());g=h.userId,console.log("State data:",h)}}catch(h){console.warn("Invalid state parameter:",h)}if(g||(g=s.session.userId,console.log("Using session userId:",g)),!g){console.log("No userId found, redirecting to login"),s.session.oauthSuccess={platform:r,message:"Please log in or register to complete the connection"},s.session.save(h=>(h&&console.error("Session save error:",h),t.redirect(`${p}/auth?oauth_success=${r}&message=Please log in or register to complete the connection`)));return}let A=`${process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002"}/auth/${r}/callback`;try{if(console.log(`Processing OAuth callback for ${r} with code: ${i.substring(0,10)}...`),r==="twitter"){let{exchangeTwitterCodeForToken:R}=await Promise.resolve().then(()=>(F(),D));try{let v=e.get(c);if(!v)throw new Error("Code verifier not found for this OAuth request");let b=await R(i,A,v);e.delete(c),await d.createSocialAccount({userId:g,platform:r,platformUserId:b.userId,username:b.username,accessToken:b.accessToken,refreshToken:b.refreshToken||null,expiresAt:b.expiresAt,isActive:!0}),console.log(`Successfully connected Twitter account ${b.username} for user ${g}`),t.redirect(`${p}/create-campaign?connected=${r}&username=${encodeURIComponent(b.username)}`);return}catch(v){console.error("Twitter OAuth error:",v),t.redirect(`${p}/create-campaign?error=oauth_error&message=${encodeURIComponent("Failed to connect Twitter account")}`);return}}let h=await n(r,g);h.success?t.redirect(`${p}/create-campaign?connected=${r}&username=${encodeURIComponent(h.username||"")}`):t.redirect(`${p}/create-campaign?error=connection_failed&message=${encodeURIComponent(h.error||"")}`)}catch(h){console.error(`OAuth token processing error for ${r}:`,h),t.redirect(`${p}/create-campaign?error=oauth_error&message=${encodeURIComponent("Failed to process authentication")}`)}}catch(r){console.error("OAuth callback error:",r);let i=process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002";t.redirect(`${i}/create-campaign?error=oauth_error&message=Authentication failed`)}});async function n(s,t){try{let i={instagram:{username:"@sparkwave_user",name:"SparkWave User"},linkedin:{username:"SparkWave User",name:"Professional Account"},facebook:{username:"SparkWave User",name:"Facebook Page"},twitter:{username:"@sparkwave_user",name:"SparkWave Twitter"}}[s];if(!i)throw new Error(`Unsupported platform: ${s}`);let c=await d.createSocialAccount({userId:t,platform:s,platformUserId:`${s}_${t}_${Date.now()}`,username:i.username,accessToken:`live_token_${s}_${Date.now()}`,refreshToken:null,expiresAt:new Date(Date.now()+60*24*60*60*1e3),isActive:!0});return console.log(`Created ${s} connection for user ${t}: ${i.username}`),{success:!0,username:i.username,accountId:c.id}}catch(r){return console.error(`Failed to create ${s} connection:`,r),{success:!1,error:r instanceof Error?r.message:"Connection failed"}}}return a.get("/auth/:platform/connect",async(s,t)=>{try{let{platform:r}=s.params,i=process.env.NODE_ENV==="production"?"https://spark-wave-1-hakopog916.replit.app":s.headers.host?`http://${s.headers.host}`:"http://localhost:3002",c=`${i}/auth/${r}/callback`;console.log("OAuth Connect Debug:",{sessionId:s.sessionID,userId:s.session.userId,platform:r,cookies:s.headers.cookie?"present":"missing"}),s.session.userId||(console.log("User not authenticated, storing pending OAuth"),console.log("Temporarily allowing OAuth without session for testing"),s.session.pendingOAuth=r,s.session.save(p=>{p&&console.error("Session save error:",p),console.log("Proceeding with OAuth despite no session")}));let l=Buffer.from(JSON.stringify({userId:s.userId||null,timestamp:Date.now()})).toString("base64"),u="";switch(r){case"instagram":u=`https://api.instagram.com/oauth/authorize?client_id=${process.env.INSTAGRAM_CLIENT_ID||"1234567890123456"}&redirect_uri=${encodeURIComponent(c)}&scope=user_profile,user_media&response_type=code&state=${l}`;break;case"linkedin":u=`https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${process.env.LINKEDIN_CLIENT_ID||"86abcdefghijkl"}&redirect_uri=${encodeURIComponent(c)}&scope=r_liteprofile r_emailaddress w_member_social&state=${l}`;break;case"facebook":u=`https://www.facebook.com/v18.0/dialog/oauth?client_id=${process.env.FACEBOOK_CLIENT_ID||"987654321098765"}&redirect_uri=${encodeURIComponent(c)}&scope=pages_manage_posts,pages_read_engagement,publish_to_groups&response_type=code&state=${l}`;break;case"twitter":let A=process.env.TWITTER_CLIENT_ID||"dzY1dU9NcW9MWEVFa09FUmxtcGk6MTpjaQ";if(!A)return t.status(400).json({message:"Twitter OAuth not configured"});let h=`${i}/auth/twitter/callback`;console.log(`Twitter OAuth redirect URI: ${h}`),console.log(`Attempting Twitter OAuth with Client ID: ${A.substring(0,10)}...`),console.log(`Redirect URI: ${h}`);let{challenge:R,verifier:v}=Re();e.set(l,v),u=`https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${A}&redirect_uri=${encodeURIComponent(h)}&scope=tweet.read%20tweet.write%20users.read&state=${l}&code_challenge=${R}&code_challenge_method=S256`;break;default:return t.status(400).json({message:"Unsupported platform"})}u&&(console.log(`Redirecting user ${s.userId} to ${r} OAuth: ${u}`),t.redirect(u))}catch(r){console.error("OAuth initiate error:",r),t.status(500).json({message:"Failed to initiate OAuth"})}}),a.get("/api/campaigns",f,async(s,t)=>{try{if(!s.userId)return t.status(401).json({message:"User not authenticated"});let r=await d.getCampaigns(s.userId);t.json({campaigns:r})}catch(r){console.error("Get campaigns error:",r),t.status(500).json({message:"Failed to get campaigns"})}}),a.get("/api/campaigns/:id",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid campaign ID"});let c=await d.getCampaign(i);if(!c||c.userId!==s.userId)return t.status(404).json({message:"Campaign not found"});t.json({campaign:c})}catch(r){console.error("Get campaign error:",r),t.status(500).json({message:"Failed to get campaign"})}}),a.post("/api/campaigns",f,te(10,60*60*1e3),async(s,t)=>{try{let r=q.parse({...s.body,userId:s.userId}),i=await d.createCampaign(r);if(i.postInstantly||i.postingTime==="instant"){console.log(`Campaign ${i.id} is set for instant posting`);let{generateAndPostInstantly:c}=await Promise.resolve().then(()=>(V(),se));c(i).catch(l=>{console.error("Failed to generate and post instantly for campaign:",i.id,l)})}else G(i).catch(c=>{console.error("Failed to generate AI content for campaign:",i.id,c)});t.json({campaign:i})}catch(r){console.error("Create campaign error:",r),t.status(400).json({message:"Invalid campaign data"})}}),a.patch("/api/campaigns/:id",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid campaign ID"});let c=await d.getCampaign(i);if(!c||c.userId!==s.userId)return t.status(404).json({message:"Campaign not found"});let l=await d.updateCampaign(i,s.body);t.json({campaign:l})}catch(r){console.error("Update campaign error:",r),t.status(500).json({message:"Failed to update campaign"})}}),a.delete("/api/campaigns/:id",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid campaign ID"});let c=await d.getCampaign(i);if(!c||c.userId!==s.userId)return t.status(404).json({message:"Campaign not found"});let l=await d.deleteCampaign(i);t.json({success:l})}catch(r){console.error("Delete campaign error:",r),t.status(500).json({message:"Failed to delete campaign"})}}),a.get("/api/campaigns/:campaignId/posts",f,async(s,t)=>{try{let{campaignId:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid campaign ID"});let c=await d.getCampaign(i);if(!c||c.userId!==s.userId)return t.status(404).json({message:"Campaign not found"});let l=await d.getPosts(i);t.json({posts:l})}catch(r){console.error("Get posts error:",r),t.status(500).json({message:"Failed to get posts"})}}),a.patch("/api/posts/:id",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid post ID"});let c=await d.getPost(i);if(!c)return t.status(404).json({message:"Post not found"});let l=await d.getCampaign(c.campaignId);if(!l||l.userId!==s.userId)return t.status(403).json({message:"Access denied"});let u=await d.updatePost(i,s.body);t.json({post:u})}catch(r){console.error("Update post error:",r),t.status(500).json({message:"Failed to update post"})}}),a.post("/api/posts/:id/approve",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid post ID"});let c=await d.getPost(i);if(!c)return t.status(404).json({message:"Post not found"});let l=await d.getCampaign(c.campaignId);if(!l||l.userId!==s.userId)return t.status(403).json({message:"Access denied"});let u=await d.updatePost(i,{status:"approved"});if(u)try{await ne(u)}catch(p){console.error("Failed to schedule post:",p)}t.json({post:u})}catch(r){console.error("Approve post error:",r),t.status(500).json({message:"Failed to approve post"})}}),a.get("/api/ai-models",async(s,t)=>{try{let r=await d.getAiModels();t.json({models:r})}catch(r){console.error("Get AI models error:",r),t.status(500).json({message:"Failed to get AI models"})}}),a.get("/api/analytics/dashboard",f,async(s,t)=>{try{if(!s.userId)return t.status(401).json({message:"User not authenticated"});let r=await d.getCampaigns(s.userId),i=[];for(let l of r){let u=await d.getPosts(l.id);i.push(...u)}let c={totalCampaigns:r.length,activeCampaigns:r.filter(l=>l.status==="active").length,postsGenerated:i.length,postsPublished:i.filter(l=>l.status==="published").length,totalReach:i.reduce((l,u)=>{let p=u.engagement;return l+(p?.reach||0)},0),totalEngagement:i.reduce((l,u)=>{let p=u.engagement;return l+(p?.likes||0)+(p?.comments||0)+(p?.shares||0)},0)};t.json({stats:c})}catch(r){console.error("Get analytics error:",r),t.status(500).json({message:"Failed to get analytics"})}}),a.get("/api/analytics/campaigns/:id",f,async(s,t)=>{try{let{id:r}=s.params,i=parseInt(r);if(isNaN(i))return t.status(400).json({message:"Invalid campaign ID"});let c=await d.getCampaign(i);if(!c||c.userId!==s.userId)return t.status(404).json({message:"Campaign not found"});let l=await d.getAnalyticsForCampaign(i);t.json({analytics:l})}catch(r){console.error("Get campaign analytics error:",r),t.status(500).json({message:"Failed to get campaign analytics"})}}),a.post("/api/analytics",f,async(s,t)=>{try{let r={...s.body,userId:s.userId},i=await d.createAnalytics(r);t.json({analytics:i})}catch(r){console.error("Create analytics error:",r),t.status(400).json({message:"Invalid analytics data"})}}),Ue(a)}import ze from"express";import me from"fs";import H from"path";import{createServer as We,createLogger as Be}from"vite";import{defineConfig as Me}from"vite";import Oe from"@vitejs/plugin-react";import x from"path";import Le from"@replit/vite-plugin-runtime-error-modal";var de=Me({plugins:[Oe(),Le(),...process.env.NODE_ENV!=="production"&&process.env.REPL_ID!==void 0?[await import("@replit/vite-plugin-cartographer").then(a=>a.cartographer())]:[]],resolve:{alias:{"@":x.resolve(import.meta.dirname,"client","src"),"@shared":x.resolve(import.meta.dirname,"shared"),"@assets":x.resolve(import.meta.dirname,"attached_assets")}},root:x.resolve(import.meta.dirname,"client"),build:{outDir:x.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0},server:{fs:{strict:!0,deny:["**/.*"]}}});import{nanoid as Ge}from"nanoid";var pe=Be();function N(a,e="express"){let n=new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0});console.log(`${n} [${e}] ${a}`)}async function ge(a,e){let n={middlewareMode:!0,hmr:{server:e},allowedHosts:!0},o=await We({...de,configFile:!1,customLogger:{...pe,error:(s,t)=>{pe.error(s,t),process.exit(1)}},server:n,appType:"custom"});a.use(o.middlewares),a.use("*",async(s,t,r)=>{let i=s.originalUrl;try{let c=H.resolve(import.meta.dirname,"..","client","index.html"),l=await me.promises.readFile(c,"utf-8");l=l.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Ge()}"`);let u=await o.transformIndexHtml(i,l);t.status(200).set({"Content-Type":"text/html"}).end(u)}catch(c){o.ssrFixStacktrace(c),r(c)}})}function he(a){let e=H.resolve(import.meta.dirname,"public");if(!me.existsSync(e))throw new Error(`Could not find the build directory: ${e}, make sure to build the client first`);a.use(ze.static(e)),a.use("*",(n,o)=>{o.sendFile(H.resolve(e,"index.html"))})}var y=Y(),Ke={origin:process.env.NODE_ENV==="production"?["https://spark-wave-1-hakopog916.replit.app","http://localhost:3002","http://localhost:5173",process.env.FRONTEND_URL||"http://localhost:3000",/\.railway\.app$/,/\.vercel\.app$/,/\.netlify\.app$/]:["http://localhost:5173","http://localhost:3000","http://localhost:3002"],credentials:!0,methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"]};y.use(Je(Ke));var He=Ve(fe);y.use(fe({secret:process.env.SESSION_SECRET||"sparkwave-secret-key-change-in-production",resave:!0,saveUninitialized:!0,store:new He({checkPeriod:864e5,ttl:24*60*60*1e3}),cookie:{secure:process.env.NODE_ENV==="production",httpOnly:!0,maxAge:24*60*60*1e3,sameSite:process.env.NODE_ENV==="production"?"strict":"lax"},name:"sparkwave-session"}));y.use(Y.json());y.use(Y.urlencoded({extended:!1}));y.use((a,e,n)=>{let o=Date.now(),s=a.path,t,r=e.json;e.json=function(i,...c){return t=i,r.apply(e,[i,...c])},e.on("finish",()=>{let i=Date.now()-o;if(s.startsWith("/api")){let c=`${a.method} ${s} ${e.statusCode} in ${i}ms`;t&&(c+=` :: ${JSON.stringify(t)}`),c.length>80&&(c=c.slice(0,79)+"\u2026"),N(c)}}),n()});(async()=>{let a=await ue(y);y.use((n,o,s,t)=>{let r=n.status||n.statusCode||500,i=n.message||"Internal Server Error";s.status(r).json({message:i}),N(`Error: ${r} - ${i}`)}),await re(),N("Post scheduler initialized"),y.get("env")==="development"?await ge(y,a):he(y);let e=parseInt(process.env.PORT||"3002",10);a.listen(e,()=>{N(`serving on port ${e}`)})})();
